<!doctype html>
<html>
  <body>
    <div id="loading">Processing...</div>
    <div id="message"></div>
    <!-- Stage Tonder SDK version -->
    <script src="https://zplit-stage.s3.amazonaws.com/v1/bundle.min.js"></script>
    <!-- Production Tonder SDK version -->
    <!-- <script src="https://zplit-prod.s3.amazonaws.com/v1/bundle.min.js"></script> -->
    <script>
        let liteSDK = null;
        (async () => {
            const params = new URLSearchParams(location.search);
            const tonderPaymentId = new URLSearchParams(window.location.search).get(
                "tndr_payment_id",
            );
            window.selectedMethod = params.get("method");
            window.amount = parseFloat(params.get("amount"));
            window.checkoutData = JSON.parse(
                decodeURIComponent(params.get("checkoutData")),
            );



            await createTonderLiteInstance();

            // Validate if the current page load is the result of a redirect
            // from a 3DS authentication or a voucher payment
            if (tonderPaymentId) {
                // This validation (verify3dsTransaction) is optional and only needed if you want to display a message
                // right after the first redirect (3DS or voucher).
                // It only works on the very first redirect — if the page is reloaded afterwards,
                // this function will not return any response.
                // If you already have your own confirmation mechanism (e.g., Tonder webhooks, static/validation returnUrl, etc.),
                // you don’t need to call this function.
                liteSDK.verify3dsTransaction().then((res) => {
                    hideLoading();
                    validateTransactionStatus(res);
                });
            }else{
                await handleLitePayment();
                hideLoading();
            }
        })();

        // create a new instance of Tonder LITE Checkout
        async function createTonderLiteInstance() {
            liteSDK = new TonderSdk.LiteInlineCheckout({
                mode: "stage",
                apiKey: "11e3d3c3e95e0eaabbcae61ebad34ee5f93c3d27",
                returnUrl: window.location.href,
                // This callback is triggered only when the payment flow finishes with
                // a "Success" or "Declined" status, without requiring 3DS authentication.
                callBack: async (response) => {
                    console.log("Payment response LITE SDK");
                    validateTransactionStatus(response);
                },
            });
            await liteSDK.injectCheckout();

            return liteSDK;
        }

        async function handleLitePayment() {
            // Create payment data with an updated amount and selected method
            let data = {
                ...checkoutData,
                cart: {
                    ...checkoutData.cart,
                    total: amount, // Update total with the entered amount
                    items: [{ ...checkoutData.cart.items[0], amount_total: amount }], // Update total with the entered amount
                },
                payment_method: selectedMethod,
            };

            const payBtn = document.getElementById(selectedMethod);
            try {
                if (payBtn) {
                    payBtn.textContent = "Processing...";
                    payBtn.disabled = true;
                }

                const res = await liteSDK.payment(data);
                console.log("Payment response:", res);

                document.getElementById("depositModal").style.display = "none";
            } catch (err) {
                console.error("Payment error:", err);
                alert("Payment failed");
            } finally {
                if (payBtn) {
                    payBtn.textContent = "DEPOSIT";
                    payBtn.disabled = false;
                }
            }
        }

        function validateTransactionStatus(transaction) {
            if (!transaction) return;
            console.log("Payment response", transaction);
            if (transaction.error) {
                console.log("Payment error", transaction.error);
                showMessage(
                    "Payment failed. Please try again or contact support.",
                )
                alert("Payment failed");
                return;
            }

            if (transaction.transaction_status === "Pending") {
                showMessage(
                    "Payment initiated successfully. Follow the voucher instructions to complete the process.",
                );
                alert(
                    "Payment initiated successfully! Please complete the payment process using the provided instructions (payment voucher). Your transaction will be confirmed once the payment is completed.",
                );
            } else if (transaction.transaction_status === "Success") {
                showMessage(
                    "Payment successful. Thank you for your deposit.",
                )
                alert("Payment successful");
            } else if (transaction.transaction_status === "Declined") {
                showMessage(
                    "Payment declined. Please check your card details or try another payment method.",
                )
                alert("Payment declined");
            }
        }

        function hideLoading() {
            try {
                const loadingElement = document.getElementById("loading");
                if (loadingElement) {
                    loadingElement.style.display = "none";
                }
            } catch {}
        }
        function showMessage(message = "") {
            try {
                const loadingElement = document.getElementById("message");
                if (loadingElement) {
                    loadingElement.innerText = message;
                }
            } catch {}
        }

    </script>
  </body>
</html>
